{% extends "core_main.html" %}
{% load thumbnail %}
{% load cropping %}

{% block message %}
    {% if message %}
        <div class="pad margin no-print">
            <div class="callout callout-info" style="margin-bottom: 0!important;">
                <h4><i class="fa fa-info"></i> Записочка</h4>
                <p>{{ message }}</p>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block content %}
      <!-- Content Wrapper. Contains page content -->
    <div id="core_product" class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <ol class="breadcrumb">
                <li><a href="#"><i class="fa fa-dashboard"></i> Главная</a></li>
                <li class="active">{{ purchase.name }}</li>
                <li>{{ catalog.catalog_name }}</li>
            </ol>
            <h1>Просмотр каталога "{{ catalog.catalog_name }}" закупки - {{ purchase.name }}</h1>
        </section>

        {% if message %}
            <div class="pad margin no-print">
                <div class="callout callout-info" style="margin-bottom: 0!important;">
                    <h4><i class="fa fa-info"></i> Записочка</h4>
                    <p>{{ message }}</p>
                </div>
            </div>
        {% endif %}

        {% if not profile %}
            <div class="pad margin no-print">
                <div class="callout callout-info" style="margin-bottom: 0!important;">
                    <h4><i class="fa fa-info"></i> Записочка</h4>
                    Для того что бы работать организатором в SP Mooscow, вам необходимо заполнить личные данные, после этого Ваша учетная запись будет рассмотренна админимтратором и ей будет присвоен соответствующий статус
                </div>
            </div>
        {% endif %}


        <!-- Main content -->
        <section class="invoice">
            <!-- Table row -->
            <div class="row">

                <div class="col-xs-6">

                    <b>ID: </b>{{ product.id }}
                    <br/>
                    <b>Name: </b>{{ product.product_name }}
                    <br/>
                    {#<a href="/profile/organizer/purchase-{{ purchase.id }}catalog-{{ catalog.id }}-edit">Изменить каталог</a>#}
                    <br/>
                </div><!-- /.col -->
                <div class="col-xs-12">
                    <div class="row">
                            <div class="col-xs-12 item">
                                {% for image in images %}
                                    <img style="" src="{% cropped_thumbnail image "cropping" scale=1 %}">
                                {% endfor %}
                                <br/>
                                {{ product.product_name }}
                                <br/>
                                {{ product.description|truncatewords:15|safe }}
                                <br/>
                                {{ product.price }} руб.
                                <br/>
                                {% if product.sku %}
                                    {{ product.sku }}
                                {% endif %}

                                <div class="properties">
                                    <b>Свойства:</b>
                                    {{ property_form }}
                                </div>

                                {{ form.errors }}
                                {{ form.non_field_errors }}

                                <form action="." method="post">{% csrf_token %}
                                    {{ form.as_p }}
{#                                    <input class="form-control " id="id_cart_id" name="cart_id" type="text">#}
{#                                    <input class="form-control " id="id_date_added" name="date_added" type="text">#}
{#                                    <input class="form-control " id="id_product" name="product" type="text">#}
{#                                    <input class="form-control " id="id_quantity" name="quantity" type="text">#}
                                    <button type="submit" id="add_to_cart" class="btn btn-primary">Купить</button>
                                </form>

                            </div>
                    </div>
                </div>
            </div><!-- /.row -->

        </section><!-- /.content -->
        <div class="clearfix"></div>
    </div><!-- /.content-wrapper -->

{% endblock %}


{% block page_js %}
    <script src='{{ STATIC_URL }}AdminLte/plugins/fastclick/fastclick.min.js'></script>
    <script src="{{ STATIC_URL }}AdminLte/dist/js/app.min.js" type="text/javascript"></script>
{#    <script src="{{ STATIC_URL }}AdminLte/dist/js/demo.js" type="text/javascript"></script>#}
<script src='{{ STATIC_URL }}js/jquery.cookie.js'></script>

    <script>
        (function($) {
            $(document).ready(function() {

                $('#add_to_cart').click(function () {
                    str = '';
                    checked_input = $('.properties input:checked');
                    var len = checked_input.length;
                    checked_input.each(function (i, elem) {
                        if (i != len - 1) {
                            str += elem.value + ',';
                        }else{
                            str += elem.value;
                        }
                    });
                    console.log('отправлено: ' + str);

                    csrftoken = $.cookie('csrftoken');
                    $.get(                    {#   TODO: Заменить на Post / не работает. #}
                        "/ajaxquery/",
                        {
                            action: 'chek_properties_product',
                            product_properties: str,
                            product_id: {{ product.id }},
                            csrfmiddlewaretoken: csrftoken
                        },
                        onAjaxSuccess
                    );
                    function onAjaxSuccess(data){
                        console.log('получено: ' + data);
{#                        $("#insertfields").append(data);#}
                        if (data=='no') {
                            console.log('Выбранные параметры не верны');
                            alert('Не найден товар с выбранными вами свойствами.');
                        }
                        else {
                            console.log('ПОКУПКА РАЗРЕШЕНА');
                            alert('Товар будет добавлен в корзину как только допишу код');
                            // тут будет аджакс запрос покупки товара
                        }
                    }


                    return false;
                });



            });
        })(jQuery);
    </script>

{% endblock %}

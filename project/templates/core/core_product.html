{% extends "core_main.html" %}
{% load thumbnail %}
{% load cropping %}

{% block page_css %}
    <!-- Theme style -->
    <link href="{{ STATIC_URL }}AdminLte/dist/css/AdminLTE.min.css" rel="stylesheet" type="text/css" />
    <link href="{{ STATIC_URL }}AdminLte/dist/css/skins/_all-skins.min.css" rel="stylesheet" type="text/css" />
    <link href="{{ STATIC_URL }}AdminLte/plugins/iCheck/square/blue.css" rel="stylesheet" type="text/css" />
{% endblock %}


{% block message %}
    {% if message %}
        <div class="pad margin no-print">
            <div class="callout callout-info" style="margin-bottom: 0!important;">
                <h4><i class="fa fa-info"></i> Записочка</h4>
                <p>{{ message }}</p>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block content %}
      <!-- Content Wrapper. Contains page content -->
    <div id="core_product" class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <ol class="breadcrumb">
                <li><a href="#"><i class="fa fa-dashboard"></i> Главная</a></li>
                <li class="active">{{ purchase.name }}</li>
                <li>{{ catalog.catalog_name }}</li>
            </ol>
            <h1>Просмотр каталога "{{ catalog.catalog_name }}" закупки - {{ purchase.name }}</h1>
        </section>

        {% if message %}
            <div class="pad margin no-print">
                <div class="callout callout-info" style="margin-bottom: 0!important;">
                    <h4><i class="fa fa-info"></i> Записочка</h4>
                    <p>{{ message }}</p>
                </div>
            </div>
        {% endif %}

        <!-- Main content -->
        <section class="invoice">
            <!-- Table row -->
            <div class="row">

                <div class="col-xs-12">

                    <h2>{{ product.product_name }}</h2>


                </div><!-- /.col -->
                <div class="col-xs-6">
                    <p>
                        <label>Описание:</label>
                        {{ product.description }}
    {#                    {{ product.description|truncatewords:15|safe }}#}
                    </p>
                    <p>
                        <label>Цена:</label> {{ product.price }} руб.
                    </p>
                    {% if product.sku %}
                        <p>
                        <label>Артикул:</label> {{ product.sku }}
                        </p>
                    {% endif %}

                    <div class="properties">
                        <b>Свойства:</b> <br/>
                        {{ property_form }}
                    </div>

                    <br/>

                    {{ cart_form.errors }}
                    {{ cart_form.non_field_errors }}

                    <form action="." method="post">{% csrf_token %}
                        {{ cart_form.as_p }}
{#                                    <input class="form-control " id="id_cart_id" name="cart_id" type="text">#}
{#                                    <input class="form-control " id="id_date_added" name="date_added" type="text">#}
{#                                    <input class="form-control " id="id_product" name="product" type="text">#}
{#                                    <input class="form-control " id="id_quantity" name="quantity" type="text">#}
                        <button type="submit" id="add_to_cart" class="btn btn-primary">Купить</button>
                    </form>

                </div>

                <div class="col-xs-6">
                    <img src="{{ MEDIA_URL }}{{ product.get_image.image }}" width="100%" height="auto" alt=""/>
{#                    {% for image in images %}#}
{#                        <img style="" src="{% cropped_thumbnail image "cropping" scale=1 %}">#}
{#                    {% endfor %}#}

                </div>                

            </div><!-- /.row -->

        </section><!-- /.content -->
        <div class="clearfix"></div>
    </div><!-- /.content-wrapper -->

{% endblock %}


{% block page_js %}
    <script src="{{ STATIC_URL }}AdminLte/plugins/iCheck/icheck.min.js" type="text/javascript"></script>
    <script src='{{ STATIC_URL }}js/jquery.cookie.js'></script>

    <script>
        (function($) {
            $(document).ready(function() {

                $('input').iCheck({
                    checkboxClass: 'icheckbox_square-blue',
                    radioClass: 'iradio_square-blue',
                    increaseArea: '20%' // optional
                });


                $('#add_to_cart').click(function () {
                    var product_properties = '';
                    var checked_input = $('.properties input:checked');
                    var len = checked_input.length;
                    checked_input.each(function (i, elem) {
                        if (i != len - 1) {
                            product_properties += elem.value + ',';
                        }else{
                            product_properties += elem.value;
                        }
                    });
                    console.log('Свойства: ' + product_properties);

                    var csrftoken = $.cookie('csrftoken');
                    $.post(
                        "",             // Урл
                        {
{#                            action: 'chek_properties_product',#}
                            ajax: 1,
                            product_properties: product_properties,
                            product: {{ product.id }},
                            quantity: $('#id_quantity').val(),
                            csrfmiddlewaretoken: csrftoken
                        },
                        onAjaxSuccess
                    );
                    function onAjaxSuccess(data){
                        console.log('получено: ' + data);
                        var result = $.parseJSON(data);
                        if(result.status == 'ok'){
                            var cart_item = $('#cart_item_' + result.cart_item_id);
                            if(cart_item.length) {  // такой товар в корзине уже есть
                                // исправляем цифры количества товара в корзине
                                cart_item.find('.product_quantity').text(parseInt(cart_item.find('.product_quantity').text()) + parseInt(result.quantity));
                                full_count_product = $('.full_count_product');
                                full_count_product.text( parseInt($(full_count_product[0]).text()) + parseInt(result.quantity) );
                                alert('Товар в корзине успешно обновлен');
                            }else{  // Значит элемент новый

                                $('#cart_item_menu').append('<li class="cart_item" id="cart_item_' + result.cart_item_id + '"> \
                                        <div class="pull-left"> \
                                              <img src="{{ product.get_image.url }}" width="50" height="50"> \
                                        </div> \
                                        <a style="padding:0 10px;" href="{{ product.url_core }}"> \
                                            <span class="product_quantity label label-success pull-right">' + result.quantity +'</span> \
                                            <h4 class="product_name" style="max-width: 80%;">{{ product.product_name }}</h4> \
                                            <p class="product_properties">' + result.properties + '</p> \
                                        </a> \
                                    </li>');
                                full_count_product = $('.full_count_product');
                                full_count_product.text( parseInt($(full_count_product[0]).text()) + parseInt(result.quantity) );
                                alert('Товар успешно добавлен в корзину');
{#                                console.log('new element');#}
                            }
                        }else if (result.status == 'no'){
                            alert('Не найдено товара с такими свойствами');
                        }else{
                            alert('Не известная ошибка');
                        }

                    }  // --/- end onAjaxSuccess function


                    return false;
                });



            });
        })(jQuery);
    </script>

{% endblock %}
